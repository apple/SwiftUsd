# Upgrade Checklist

Checklist for upgrading SwiftUsd to be based on a new OpenUSD version

## 1. Build new vanilla OpenUSDs
1. Update source repo
```
cd ~/OpenUSD
git switch release
git pull
```
Verify that `git log` shows the expected tag and the working tree is clean

2. Build OpenUSD with no extra flags to `/opt/local/OpenUSD`
```
rm -rf /opt/local/OpenUSD
cd ~/OpenUSD
python3 build_scripts/build_usd.py /opt/local/OpenUSD
```
This is mostly a smoke test to make sure your development can build vanilla OpenUSD properly. (E.g. if you have homebrew, vanilla OpenUSD might run into issues building if you don't add `--ignore-homebrew` as a build option.) I like to `usdview` a model or two after the build finishes

3. Build OpenUSD with `--no-python` to `/opt/local/OpenUSD_no-python`
```
rm -rf /opt/local/OpenUSD_no-python
cd ~/OpenUSD
python3 build_scripts/build_usd.py --no-python /opt/local/OpenUSD_no-python
```
This build will be used by `ast-answerer` later

## 2. Upgrade SwiftUsd/openusd-source
1. Undo the old patch
```
cd ~/SwiftUsd/openusd-source
git restore .
git clean -fd
git status
```
Make sure the working tree is clean

2. Update the source repo
```
git switch release
git pull
```
Verify that `git log` shows the expected tag and the working tree is clean

3. Apply the hunks from `~/SwiftUsd/openusd-patch.patch` to `~/SwiftUsd/openusd-source`  
The size of the patch has shrunk a lot from what it used to be, so I prefer to manually apply the hunks by hand instead of using `patch`. Sometimes hunks get moved around or are no longer needed, and I want to have at least briefly looked at any changes that are near any of the hunks in the patch, in case there are changes in the new version of OpenUSD that impact any of the hunks.

4. [Generate a new openusd-patch.patch](<doc:CheatSheet#Generating-a-new-patch>) and check in into the repo as `~/SwiftUsd/openusd-patch.patch`

5. [Rebuild the OpenUSD dylibs in SwiftUsd](<doc:BuildingLocally>). Remember to remove `~/SwiftUsd/openusd-builds/*` first. 

## 3. Run ast-answerer on the new /opt/local/OpenUSD_no-python
Make sure to remove the `build/AstAnswererOutputs` file to run the analysis from scratch. You may need to make small modifications to `ast-answerer` and re-run it multiple times, because it's designed to be very sensitive to any changes in OpenUSD. (For example, if OpenUSD removes some source files or types, that will often cause `ast-answerer`'s internal tests to fail. ast-answerer is intentionally brittle in this fashion, because it's worth taking the time to double check that those files/types really were removed, instead of ast-answerer somehow now missing files/types in a new OpenUSD that are still present.)

## 4. Normal upgrade/release process for SwiftUsd
Follow the [Release Checklist](<doc:ReleaseChecklist>), this is just an abridged overview of the process. Also, if there are new compiler errors/bugs that arise from the new OpenUSD version, you'll have to fix them, and may need to redo prior steps multiple times, such as modifying the patch and rebuilding OpenUSD dylibs for SwiftUsd. 
1. Move the code generated by `ast-answerer` to `~/SwiftUsd/generated/*`
2. Remove `~/SwiftUsd/swift-package`, then run `~/SwiftUsd/scripts/make-swift-package`.
3. Upgrade the Pixar namespace in `~/SwiftUsd/source/OpenUSD.swift`
4. Test SwiftUsd. Aside from using [SwiftUsd-Tests](https://github.com/apple/SwiftUsd-Tests), opt for full testing of all processes, including iOS apps and running the test suite on multiple Macs. Updating to a new OpenUSD version is a significant change.
> Important: If there are test failures in the test suite, investigate them until you 100% understand them. The test suite has caught serious regressions in two published releases of OpenUSD to date, so test failures are likely either indicative of correct changes in OpenUSD's behavior, or new regressions.
5. Update documentation, then release SwiftUsd